<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Join local JSON data with vector tile geometries</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>

    <!--LIBRARY STARTS-->
     <script type="text/javascript">
      function getColor(cat){
        if(100<=cat){
            return '#7a0177';
        }else if((40<=cat)&&(cat<100)){
            return '#c51b8a';
        }else if((20<=cat)&&(cat<40)){
            return '#f768a1';
        }else if((10<=cat)&&(cat<20)){
            return '#fa9fb5';
        }else if((5<=cat)&&(cat<10)){
            return '#fcc5c0';
        }else if((0<=cat)&&(cat<5)){
            return '#feebe2'; 
        }else{
            '#000';
        }
      };

      function getMax(arr, prop) {
        var max;
        for (var i=0 ; i<arr.length ; i++) {
            if (!max || parseInt(arr[i][prop]) > parseInt(max[prop]))
                max = arr[i];
        }
        return max;
      };
    </script>

    <!--LIBRARY ENDS-->
</head>
<body>


<div id='map'>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibmV3YW1lcmljYSIsImEiOiIyM3ZnYUtrIn0.57fFgg_iM7S1wLH2GQC71g';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v9',
    center: [-99.9, 41.5],
    zoom: 4
});

// Join local JSON data with vector tile geometry
// USA unemployment rate in 2009
// Source https://data.bls.gov/timeseries/LNS14000000


$.getJSON('https://storage.googleapis.com/thieme-us-query/477/477_mapbox_data_layer.json', function(data) {
    //data is the JSON string
  map.on('load', function() {

      // Add source for state polygons hosted on Mapbox, based on US Census Data:
      // https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html
      map.addSource("states", {
          type: "vector",
          url: "mapbox://newamerica.2r79v4mv"
      });

      var expression = ["match", ["get", "GEOID"]];

      // Calculate color for each state based on the unemployment rate
      data.forEach(function(row) {
          var color =getColor(row["med_dl.x"]);
          expression.push(row["GEOID"], color);
      });

      // Last value is the default, used where there is no data
      //
      expression.push("rgba(0,0,0,0)");

      // Add layer from the vector tile source with data-driven style
      map.addLayer({
          "id": "states-join",
          "type": "fill",
          "source": "states",
          "source-layer": "SOTI_mapbox_census_layer",
          "paint": {
              "fill-color": expression
          }
      }, 'waterway-label');
  });

});
</script>

</body>
</html>