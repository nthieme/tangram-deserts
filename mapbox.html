<!-- REMEMBER YOU:RE ADDING IN THE SECTION THAT LETS YOU FLIP BETWEEN HOUSES TO DO THAT YOU NEED TO ADD IN THE UPPER HOUSE SHAPEFILE AND SPLITOFF THE JSON -->
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>How fast is the internet in the U.S.?</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body { margin:0; padding:0; }
      #map { position:absolute; top:0; bottom:0; width:100%; }
      #menu {
        background: #fff;
        position: absolute;
        z-index: 1;
        top: 10px;
        right: 10px;
        border-radius: 3px;
        width: 120px;
        border: 1px solid rgba(0,0,0,0.4);
        font-family: 'Open Sans', sans-serif;
      }
    #zoom_menu {
        background: #fff;
        position: absolute;
        z-index: 1;
        top: 140px;
        right: 10px;
        border-radius: 3px;
        width: 120px;
        border: 1px solid rgba(0,0,0,0.4);
        font-family: 'Open Sans', sans-serif;
      }

      .menu a {
        font-size: 13px;
        color: #404040;
        display: block;
        margin: 0;
        padding: 0;
        padding: 10px;
        text-decoration: none;
        border-bottom: 1px solid rgba(0,0,0,0.25);
        text-align: center;
      }

      .menu a:last-child {
        border: none;
      }

      .menu a:hover {
        background-color: #f8f8f8;
        color: #404040;
      }

      .menu a.active {
        background-color: #3887be;
        color: #ffffff;
      }

      .menu a.active:hover {
        background: #3074a4;
      }
      .map-overlay {
        position: relative;
        background: rgba(255, 255, 255, 0.8);
        margin-right: 20px;
        font-family: Arial, sans-serif;
        overflow: auto;
        border-radius: 3px;
      }
      .legend {
        padding: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        line-height: 18px;
        margin-bottom: 40px;
        display: inline-block;
      }

      .legend div{
        display:table;
      }

      .legend-key {
        display: inline-block;
        border-radius: 20%;
        width: 10px;
        height: 10px;
        margin-right: 5px;
      }
      .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      }
    </style>

    <!--LIBRARY STARTS-->
     <script type="text/javascript">
      function getColor(cat){
        if(100<=cat){
            return '#7a0177';
        }else if((40<=cat)&&(cat<100)){
            return '#c51b8a';
        }else if((20<=cat)&&(cat<40)){
            return '#f768a1';
        }else if((10<=cat)&&(cat<20)){
            return '#fa9fb5';
        }else if((5<=cat)&&(cat<10)){
            return '#fcc5c0';
        }else if((0<=cat)&&(cat<5)){
            return '#feebe2'; 
        }else{
            '#000';        
        }
      };

      function getColorcomp(cat){
          if(25<=cat){
        return '#de5600';
      }else if((15<=cat)&&(cat<25)){
        return '#ff7179';
      }else if((5<=cat)&&(cat<15)){
        return '#ffa4cc';
      }else if((-5<=cat)&&(cat<5)){
        return '#ffd9fe';
      }else if((-15<=cat)&&(cat<-5)){
        return '#ca93d5';
      }else if((-25<=cat)&&(cat<-15)){
        return '#8f52b1';
      }else if(cat<-25){
        return '#49108f';  
            }else{
              '#000';
            }
        };


      function getMax(arr, prop) {
        var max;
        for (var i=0 ; i<arr.length ; i++) {
            if (!max || parseInt(arr[i][prop]) > parseInt(max[prop]))
                max = arr[i];
        }
        return max;
      };

      function createLegend(labels, colors, div_legend){
        for (i = 0; i < labels.length; i++) {
          var label = labels[i];
          var color = colors[i];
          var item = document.createElement('div');
          var key = document.createElement('span');
          key.className = 'legend-key';
          key.style.backgroundColor = color;

          var value = document.createElement('span');
          value.innerHTML = label;
          item.appendChild(key);
          item.appendChild(value);
          div_legend.append(item);
        }
      }


    function createColorvector(data, data_name) {
      var expression_speed_mlab = ["match", ["get", data_name]];
      var expression_speed_477 = ["match", ["get", data_name]];
      var expression_speed_diff = ["match", ["get", data_name]];

      data.forEach(function(row){
        if(row[data_name]===undefined){
        //do nothing
        }else{
          var color_mlab =getColor(row["speed_mlab"]);
          var color_477 =getColor(row["speed_477"]);
          var color_diff =getColorcomp(row["speed_diff"]);

          if(color_mlab== undefined){
            color_mlab="rgba(0,0,0,0)";
          }else{
            //don't change anything
          }
          if(color_477== undefined){
            color_477="rgba(0,0,0,0)";
          }else{
            //don't change anything
          }
          if(color_diff== undefined){
            color_diff="rgba(0,0,0,0)";
          }else{
            //don't change anything
          }
          expression_speed_mlab.push(row[data_name], color_mlab);
          expression_speed_477.push(row[data_name], color_477); 
          expression_speed_diff.push(row[data_name], color_diff);
        }
      });
    

      expression_speed_mlab.push("rgba(0,0,0,0)");
      expression_speed_477.push("rgba(0,0,0,0)");
      expression_speed_diff.push("rgba(0,0,0,0)");

      return([expression_speed_mlab,expression_speed_477,expression_speed_diff])
    }

    function turnOffOtherMaps(current_map){
      for(var i =0; i <zoom_names.length;i++){
        for(var j = 0; j < keys.length; j++){
          var map_name = zoom_names[i]+"_"+keys[j];
          var map_pred = keys[j]
          if(map_pred!=current_map){
            map.setLayoutProperty(map_name+"_id", 'visibility', 'none')
          }
        }
      }
    }

    function makeToggle(toggleIDs, active_level, id_name){

      for (var i = 0; i < toggleIDs.length; i++) {
      var id = toggleIDs[i];

      var link = document.createElement('a');
      link.href = '#';
      if(id==active_level){
        link.className = 'active';
      }else{
        link.className = '';
      }

      link.textContent = toggleIDs[i];
        link.id = id;

        var layers = document.getElementById(id_name);
        layers.appendChild(link);
      }

  }
    
    


    </script>

    <!--LIBRARY ENDS-->
</head>
<body>

<div id="div_menu">
<nav id="menu" class="menu"></nav>
<nav id ="zoom_menu" class="menu"></nav>
</div>
<div id='map'></div>
<div class='map-overlay legend initial' id='legend_diff'></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibmV3YW1lcmljYSIsImEiOiIyM3ZnYUtrIn0.57fFgg_iM7S1wLH2GQC71g';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v9',
    center: [-99.9, 41.5],
    zoom: 3
});

// Join local JSON data with vector tile geometry

var keys = ["speed_mlab","speed_477" ,"speed_diff"];
var legend_grouping = {"speed_mlab":"legend_mbps", "speed_477":"legend_mbps", "speed_diff":"legend_diff"};
var zoom_names = ["zcta","house_"];
var data_names = ["zcta","house_num"];
var zoomThreshold = 4 ;
var toggleableLayerIds = keys;
var label_link = ["M-Lab data", "FCC's 477 data"," Difference"];
var label_leg_filt = ["State House","State Senate"];
var active_zoom = "State House";
var active_map = "speed_mlab";
var speed_mlab_labels = ["Greater than 100","40 to 100","20 to 40","10 to 20","5 to 10","0 to 5"];
var speed_mlab_colors =['#7a0177','#c51b8a', '#f768a1', '#fa9fb5', '#fcc5c0',  '#feebe2'];

var speed_477_labels = speed_mlab_labels;
var speed_477_colors = speed_mlab_colors;

var speed_diff_labels = ["Greater than 25","15 to 25","5 to 15","-5 to 5","-15 to -5","-25 to -15", "Less than -25"];
var speed_diff_colors = ['#de5600', '#ff7179','#ffa4cc','#ffd9fe','#ca93d5','#8f52b1','#49108f'];

var zoomed = false;


for (var i = 0; i < toggleableLayerIds.length; i++) {
    var id = toggleableLayerIds[i];

    var link = document.createElement('a');
    link.href = '#';
    if(id==active_map){
      link.className = 'active';
    }else{
      link.className = '';
    }

    link.textContent = label_link[i];
    link.id = id;

    link.onclick = function (e) {
      var zoom = map.getZoom();
      if(zoom>zoomThreshold){
        var pred = zoom_names[1];
      }else{
        var pred = zoom_names[0];
      }

        var clickedLayer = this.id;
        e.preventDefault();
        e.stopPropagation();

        var visibility = map.getLayoutProperty(pred+"_"+clickedLayer+"_id", 'visibility');

        if (visibility === 'visible') {
          //
        } else {
            this.className = 'active';
            var legend_div = document.createElement("div");


              legend_div.className ="map-overlay legend" +" "+ clickedLayer;
              legend_div.id=legend_grouping[clickedLayer];
              document.body.appendChild(legend_div);
              var curr_legend = $("."+clickedLayer);
              var to_make_inactive_div= $('div.map-overlay')
        .empty();
                createLegend(eval(clickedLayer+"_"+"labels"), eval(clickedLayer+"_"+"colors"), curr_legend);
              $('div.map-overlay')
                .filter(":empty")
                .remove() 



            turnOffOtherMaps(clickedLayer);
      $('#div_menu a')
        .filter(".active")
        .not( "[id='"+clickedLayer+"']" )
        .removeClass("active"); 

      for(var j =0; j<zoom_names.length; j++){
              map.setLayoutProperty(zoom_names[j]+"_"+clickedLayer+"_id", 'visibility', 'visible');
            }
        }
    };

    var layers = document.getElementById('menu');
    layers.appendChild(link);
}



var starting_map = $(".legend");
starting_map.addClass(active_map);

createLegend(eval(active_map+"_"+"labels"), eval(active_map+"_"+"colors"), starting_map);



//this is temp for the legislative districts stuff

//$.getJSON('https://storage.googleapis.com/thieme-us-query/477/full_speed_data_zcta_data_use.json', function(data) {
  
  $.getJSON('https://storage.googleapis.com/thieme-us-query/477/mapbox_zcta_leg.json', function(data) {
  
    //data is the JSON string
  map.on('load', function() {
   map.addSource("legislative", {
        type: "vector",
    url: "mapbox://newamerica.7arz3f2z"
   
    });

   map.addSource("county", {
        type: "vector",
        url: "mapbox://newamerica.11qvqbyq"
    });


    var colorArray =[];
    for(var i =0; i<zoom_names.length; i++){
      colorArray.push(createColorvector(data[zoom_names[i]], data_names[i]));
    }

          // Add layer from the vector tile source with data-driven style
    for(var i =0; i <zoom_names.length;i++){
      for(var j = 0; j < keys.length; j++){
        

        if(zoom_names[i]=="house_"){
          map.addLayer({
              "id": zoom_names[i]+"_"+keys[j]+"_id",
              "type": "fill",
              "source": "legislative",
              "source-layer": "full_speed_data_census_leg-7upuu0",
              'minzoom': zoomThreshold,
              "visibility": "none",
              "paint": {
                  "fill-color": colorArray[i][j] 
              }
            }, 'waterway-label'
           );
        }else if (zoom_names[i]=="zcta"){
          map.addLayer({
              "id": zoom_names[i]+"_"+keys[j]+"_id",
              "type": "fill",
              "source": "county",
              "source-layer": "full_speed_data_census_base_use",
              'maxzoom': zoomThreshold,
              "visibility": "none",
              "paint": {
                  "fill-color": colorArray[i][j] 
              }
            }, 'waterway-label'
           );
        }
     
      }
    }

    turnOffOtherMaps(active_map);


    //add story popups
    map.addLayer({
        "id": "places",
        "type": "symbol",
        "source": {
            "type": "geojson",
            "data": {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "properties": {
                        "description": "<strong>North Dakota's Internet Exceptionalism</strong><p>The internet speeds in North Dakota look more like California's and New York's than the ones in neighboring Wyoming and Montana. <a href=\"https://nthieme.github.io/tangram-deserts/ND_blog.htm\" target=\"_blank\" title=\"Opens in a new window\">Click here to find out what makes them so different.</a> </p>",
                        "icon": "library"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-101.5649, 46.4178] 
                    }                
                  }]
            }
        },
        "layout": {
            "icon-image": "{icon}-15",
            "icon-allow-overlap": true,
            "icon-size":1.4
        }
    });

    //make story popups work
    map.on('click', 'places', function (e) {
        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = e.features[0].properties.description;

        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(description)
            .addTo(map);
    });

    // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', 'places', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'places', function () {
        map.getCanvas().style.cursor = '';
    });

    map.on('zoom', () => {
      var currentZoom = map.getZoom();
      if ((currentZoom > zoomThreshold) && (zoomed==false)) {
          makeToggle(label_leg_filt, active_zoom, "zoom_menu");
          zoomed=true
      } else if((currentZoom > zoomThreshold) && (zoomed==true)){
        //
      }else{
          $('#zoom_menu').
          empty();
          zoomed=false
      }
    });


  }); // closes map load
}); //closes JSON load


</script>



</body>
</html>